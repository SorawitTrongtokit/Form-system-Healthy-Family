name: Supabase to Google Drive Backup

on:
  schedule:
    - cron: '0 0 * * *' # รันทุกเที่ยงคืน
  workflow_dispatch: # ปุ่มกดรันเอง

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump Database (IPv4 Forced)
        shell: bash
        run: |
          # ใช้ --no-password และดึงข้อมูลผ่าน URI
          # เพิ่มการ retry เผื่อกรณี Network สะดุด
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i to dump database..."
            # ใช้ pg_dump โดยตรงจาก Secret URL
            if pg_dump "${{ secrets.SUPABASE_DB_URL }}" > backup.sql; then
              echo "Dump successful!"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "Error: Failed to dump database after $MAX_RETRIES attempts."
                exit 1
              fi
              echo "Dump failed, retrying in 10 seconds..."
              sleep 10
            fi
          done

      - name: Compress Backup
        run: |
          tar -czvf backup_$(date +%Y-%m-%d).tar.gz backup.sql

      - name: Install Rclone
        run: sudo curl https://rclone.org/install.sh | sudo bash

      - name: Configure Rclone
        run: |
          mkdir -p ~/.config/rclone
          cat <<EOF > ~/.config/rclone/rclone.conf
          [gdrive]
          type = drive
          scope = drive
          service_account_contents = ${{ secrets.GDRIVE_SA_JSON }}
          EOF

      - name: Upload to Google Drive
        run: |
          # ใช้ -P เพื่อดูความคืบหน้าใน Log
          rclone copy -P backup_$(date +%Y-%m-%d).tar.gz gdrive:${{ secrets.GDRIVE_FOLDER_ID }}
