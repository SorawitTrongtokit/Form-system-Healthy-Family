name: Backup Supabase to Google Drive

on:
  schedule:
    # Run every day at 2:00 AM UTC (9:00 AM Thailand)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rclone
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone

      - name: Configure Rclone for Google Drive
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Create backup using Supabase API
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Export each table as JSON
          mkdir -p backups
          
          # Use Supabase REST API to export data
          TABLES=("volunteers" "houses" "residents" "health_records")
          
          for TABLE in "${TABLES[@]}"; do
            echo "Exporting $TABLE..."
            curl -s "https://${SUPABASE_PROJECT_REF}.supabase.co/rest/v1/${TABLE}?select=*" \
              -H "apikey: ${{ secrets.SUPABASE_SERVICE_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_KEY }}" \
              > "backups/${TABLE}_${TIMESTAMP}.json"
          done
          
          # Create archive
          tar -czvf "backups/supabase_backup_${TIMESTAMP}.tar.gz" backups/*.json
          rm backups/*.json
          
          echo "BACKUP_FILE=backups/supabase_backup_${TIMESTAMP}.tar.gz" >> $GITHUB_ENV
          echo "‚úÖ Backup created: supabase_backup_${TIMESTAMP}.tar.gz"

      - name: Upload to Google Drive
        run: |
          rclone copy "${{ env.BACKUP_FILE }}" gdrive:Backups/anamai-db/
          echo "‚úÖ Uploaded to Google Drive"

      - name: Cleanup old backups on Drive (keep last 30)
        run: |
          rclone lsf gdrive:Backups/anamai-db/ --files-only | sort -r | tail -n +31 | while read file; do
            rclone delete "gdrive:Backups/anamai-db/$file"
            echo "üóëÔ∏è Deleted old backup: $file"
          done

      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Backup completed successfully"
          else
            echo "‚ùå Backup failed"
          fi
